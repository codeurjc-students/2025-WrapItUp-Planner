name: Manual publish (workflow_dispatch)

on:
  workflow_dispatch:
    inputs:
      use_tag:
        description: 'Optional tag to use. If empty, generated as <branch>-<YYYYMMDDHHMM>-<shortsha>'
        required: false
      ref:
        description: 'Optional git ref (branch or commit) to build from'
        required: false

jobs:
  build-and-push-manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout provided ref (if supplied)
        if: ${{ github.event.inputs.ref != '' }}
        run: git checkout ${{ github.event.inputs.ref }}

      - name: Compute tag
        id: compute
        run: |
            if [ -n "${{ github.event.inputs.use_tag }}" ]; then
            echo "tag=${{ github.event.inputs.use_tag }}" >> $GITHUB_OUTPUT
            exit 0
            fi
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            # Sanitize branch name by replacing / with - and make lowercase
            BRANCH=$(echo "${BRANCH//\//-}" | tr '[:upper:]' '[:lower:]')
            SHORTSHA=$(git rev-parse --short HEAD)
            DATE=$(date -u +"%Y%m%d%H%M")
            TAG="${BRANCH}-${DATE}-${SHORTSHA}"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push image (manual)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: arturox2500/wrapitup_planner:${{ steps.compute.outputs.tag }}
          platforms: linux/amd64

      - name: Install oras
        run: |
          ORAS_VER=0.16.0
          curl -sSL -o oras.tar.gz https://github.com/oras-project/oras/releases/download/v${ORAS_VER}/oras_${ORAS_VER}_linux_amd64.tar.gz
          tar -xzf oras.tar.gz
          sudo mv oras /usr/local/bin/
        env:
          ORAS_EXPERIMENTAL: "1"

      - name: Push docker-compose.yml as OCI artifact (manual)
        run: |
          TAG=${{ steps.compute.outputs.tag }}
          oras push docker://docker.io/arturox2500/wrapitup_planner:${TAG} docker/docker-compose.yml:application/vnd.docker.compose.file.v1+yaml

        env:
          ORAS_EXPERIMENTAL: "1"