name: Publish on release

on:
  release:
    types: [ published ]

jobs:
  verify-and-publish:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: arturox2500/wrapitup_planner
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set TAG
        id: tag
        run: echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

      - name: Verify backend pom.xml version matches tag
        run: |
          TAG=${{ github.event.release.tag_name }}
          POM=backend/wrapitup_planner/pom.xml
          if [ ! -f "$POM" ]; then echo "Missing $POM" && exit 1; fi
          POM_VER=$(grep -m1 '<version>' "$POM" | sed -E 's/.*<version>([^<]+)<\/version>.*/\1/')
          if [ "$POM_VER" != "$TAG" ]; then echo "pom.xml version ($POM_VER) != tag ($TAG)" && exit 1; fi

      - name: Verify frontend package.json version matches tag
        run: |
          TAG=${{ github.event.release.tag_name }}
          PKG=frontend/WrapItUp-Planner/package.json
          if [ ! -f "$PKG" ]; then echo "Missing $PKG" && exit 1; fi
          PKG_VER=$(jq -r .version "$PKG")
          if [ "$PKG_VER" != "$TAG" ]; then echo "package.json version ($PKG_VER) != tag ($TAG)" && exit 1; fi

      - name: Verify docker/docker-compose.yml image tag matches release
        run: |
          TAG=${{ github.event.release.tag_name }}
          COMPOSE=docker/docker-compose.yml
          if [ ! -f "$COMPOSE" ]; then echo "Missing $COMPOSE" && exit 1; fi
          grep -q "image:.*:${TAG}" "$COMPOSE" || (echo "docker-compose image tag not matching $TAG" && exit 1)

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push image (release + latest)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: |
            arturox2500/wrapitup_planner:${{ github.event.release.tag_name }},
            arturox2500/wrapitup_planner:latest
          platforms: linux/amd64

      - name: Install oras
        run: |
          ORAS_VER=0.16.0
          curl -sSL -o oras.tar.gz https://github.com/oras-project/oras/releases/download/v${ORAS_VER}/oras_${ORAS_VER}_linux_amd64.tar.gz
          tar -xzf oras.tar.gz
          sudo mv oras /usr/local/bin/
        env:
          ORAS_EXPERIMENTAL: "1"

      - name: Push docker-compose.yml as OCI artifact (release)
        run: |
          TAG=${{ github.event.release.tag_name }}
          oras push docker://arturox2500/wrapitup_planner:${TAG} docker/docker-compose.yml:application/vnd.docker.compose.file.v1+yaml
          oras push docker://arturox2500/wrapitup_planner:latest docker/docker-compose.yml:application/vnd.docker.compose.file.v1+yaml
        env:
          ORAS_EXPERIMENTAL: "1"